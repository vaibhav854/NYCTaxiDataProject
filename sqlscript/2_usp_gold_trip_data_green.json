{
	"name": "2_usp_gold_trip_data_green",
	"properties": {
		"folder": {
			"name": "nyc_taxi/usp"
		},
		"content": {
			"query": "USE nyc_taxi_ldw\ngo\n\n\n-- stored procedure for the first requirement \n-- CREATE OR ALTER PROCEDURE gold.usp_gold_trip_data_green\n-- @year VARCHAR(4),\n-- @month VARCHAR(2)\n-- as\n-- BEGIN\n--     DECLARE @create_sql_stmt NVARCHAR(MAX),\n--             @drop_sql_stmt NVARCHAR(max);\n--     SET @create_sql_stmt  = \n--         'CREATE EXTERNAL TABLE gold.trip_data_green_'+ @year + '_'+ @month  + ' ' +\n--         'WITH \n--         (\n--             data_source = nyc_taxi_src,\n--             location = ''gold/trip_data_green_csv/year=' +@year+'/month='+@month+''',\n--             file_format = parquet_file_format\n--         )\n--         as \n--         SELECT td.year,\n--        td.month,\n--         tz.borough,\n--         CONVERT(DATE,td.lpep_pickup_datetime) as trip_date,\n--         cal.day_name as trip_day,\n--         CASE when cal.day_name IN (''Saturday'',''Sunday'') THEN ''Y'' ELSE ''N'' END as trip_day_weekend_ind,\n--         SUM(CASE when Pt.payment_type_desc = ''Credit card'' then 1 else 0 end) as card_trip_count,\n--         SUM(case when Pt.payment_type_desc = ''Cash'' THEN 1 else 0 end ) as cash_trip_count\n--         from silver.vw_trip_data_green_csv td\n--         JOIN silver.taxi_zone tz\n--         ON td.pu_location_id = tz.location_id\n--         JOIN silver.calendar cal\n--         on cal.date =  CONVERT(DATE,td.lpep_pickup_datetime)\n--         join silver.vw_payment_type Pt \n--         on td.payment_type = Pt.payment_type\n--         where td.year = '''+@year+'''\n--         and \n--         td.month  = '''+ @month + '''\n--                 GROUP BY td.year,\n--             td.month,\n--                 tz.borough,\n--                 CONVERT(DATE,td.lpep_pickup_datetime),\n--                 cal.day_name\n--             '\n--     print(@create_sql_stmt)\n--     EXEC  sp_executesql @create_sql_stmt;\n--     SET @DROP_SQL_STMT =\n--         'DROP EXTERNAL TABLE gold.trip_data_green_' + @year+'_'+ @month \n--     print(@drop_sql_stmt)\n--      EXEC  sp_executesql @drop_sql_stmt;\n-- end ;\n\n\n\n -- create store procedure for the second requirement \n \nCREATE OR ALTER PROCEDURE gold.usp_gold_trip_data_green\n@year VARCHAR(4),\n@month VARCHAR(2)\nas\nBEGIN\n    DECLARE @create_sql_stmt NVARCHAR(MAX),\n            @drop_sql_stmt NVARCHAR(max);\n    SET @create_sql_stmt  = \n        'CREATE EXTERNAL TABLE gold.trip_data_green_'+ @year + '_'+ @month  + ' ' +\n        'WITH \n        (\n            data_source = nyc_taxi_src,\n            location = ''gold/trip_data_green/year=' +@year+'/month='+@month+''',\n            file_format = parquet_file_format\n        )\n        as \n        SELECT td.year,\n       td.month,\n        tz.Borough,\n        CONVERT(DATE,td.lpep_pickup_datetime) as trip_date,\n        cal.day_name as trip_day,\n        CASE when cal.day_name IN (''Saturday'',''Sunday'') THEN ''Y'' ELSE ''N'' END as trip_day_weekend_ind,\n        SUM(CASE when Pt. payment_type_desc = ''Credit card'' then 1 else 0 end) as card_trip_count,\n        SUM(case when Pt. payment_type_desc = ''Cash'' THEN 1 else 0 end ) as cash_trip_count,\n        SUM (case when tt.trip_type_desc = ''street-hail'' then 1 else 0 end) as street_hail_trip_count,\n        SUM (case when tt.trip_type_desc = ''Dispatch'' then 1 else 0 end) as dispatch_trip_count,\n        sum(td.trip_distance) as trip_distance,\n        sum(datediff(minute,td.lpep_pickup_datetime,td.lpep_dropoff_datetime)) as trip_duration,\n        sum(td.fare_amount) as fare_amount\n        from silver.vw_trip_data_green td\n        JOIN silver.taxi_zone tz\n        ON td.PULocationID = tz.LocationID\n        JOIN silver.calendar cal\n        on cal.date =  CONVERT(DATE,td.lpep_pickup_datetime)\n        join silver.payment_type Pt \n        on td.payment_type = Pt.payment_type\n        join silver.trip_type tt \n        on td.trip_type = tt.trip_type \n        where td.year = '''+@year+'''\n        and \n        td.month  = '''+ @month + '''\n                GROUP BY td.year,\n            td.month,\n                tz.Borough,\n                CONVERT(DATE,td.lpep_pickup_datetime),\n                cal.day_name\n            '\n    print(@create_sql_stmt)\n    EXEC  sp_executesql @create_sql_stmt;\n    SET @DROP_SQL_STMT =\n        'DROP EXTERNAL TABLE gold.trip_data_green_' + @year+'_'+ @month+' ' \n    print(@drop_sql_stmt)\n     EXEC  sp_executesql @drop_sql_stmt;\nend ;\n\n\nselect * from silver.taxi_zone;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "nyc_taxi_ldw",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}